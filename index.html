<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Faciliation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: #F5F3FF;
            color: #1F2937;
            min-height: 100vh;
            padding: 10px 10px 40px 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            height: calc(100vh - 50px);
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            padding: 0;
            margin-top: 30px;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 700;
            color: #6D28D9;
            margin: 0;
            line-height: 1.2;
        }

        .header p {
            color: #6B7280;
            font-size: 16px;
            margin-top: 2px;
            line-height: 1.2;
        }

        /* Sidebar - Member Roster */
        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #6D28D9;
            font-weight: 600;
        }

        .member-filter {
            margin-bottom: 15px;
        }

        .member-filter select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #6D28D9;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .member-filter select:hover {
            border-color: #8B5CF6;
        }

        .member-filter select:focus {
            outline: none;
            border-color: #6D28D9;
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.1);
        }

        .member-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .member-card {
            background: #8B5CF6;
            color: white;
            padding: 15px 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            min-height: 50px;
        }

        .member-card:hover {
            background: #7C3AED;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }

        .member-name {
            font-weight: 600;
            font-size: 16px;
            flex: 1;
            min-width: 0;
            word-wrap: break-word;
        }

        .speak-count-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
            line-height: 1;
        }

        .speak-count-badge.high {
            background: #EF4444;
            color: white;
        }

        .member-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .btn-small {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-add {
            background: white;
            color: #8B5CF6;
        }

        .btn-add:hover {
            background: #F5F3FF;
            transform: scale(1.05);
        }

        .btn-response {
            background: #C4B5FD;
            color: white;
        }

        .btn-response:hover {
            background: #A78BFA;
            transform: scale(1.05);
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 0;
            overflow-y: auto;
            height: 100%;
        }

        .current-speaker {
            background: #6D28D9;
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .current-speaker.empty {
            background: #E5E7EB;
            color: #6B7280;
        }

        .current-speaker-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .current-speaker-name {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .current-speaker-count {
            font-size: 16px;
            opacity: 0.9;
        }

        .speaker-action-btn {
            margin-top: 20px;
            width: 100%;
        }

        .speaker-response-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .response-queue {
            background: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .response-queue h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #6D28D9;
            font-weight: 600;
        }

        .response-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100px;
            flex: 1;
        }

        .response-item {
            background: #F59E0B;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        .response-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .response-item-name {
            font-weight: 600;
            font-size: 16px;
        }

        .response-item-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .response-action-btn {
            margin-top: 15px;
            width: 100%;
        }

        .stack-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .stack-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #6D28D9;
            font-weight: 600;
        }

        .stack-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            min-height: 200px;
        }

        .stack-list .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stack-item {
            background: #A78BFA;
            color: #1F2937;
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .stack-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .stack-position {
            background: rgba(255, 255, 255, 0.3);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .stack-item.response .stack-position {
            background: rgba(255, 255, 255, 0.3);
        }

        .stack-item-name {
            font-weight: 600;
            font-size: 16px;
        }

        .stack-item-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-remove {
            background: rgba(139, 92, 246, 0.2);
            color: #6D28D9;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-remove:hover {
            background: #8B5CF6;
            color: white;
        }

        .stack-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: #8B5CF6;
            color: white;
        }

        .btn-primary:hover {
            background: #7C3AED;
        }

        .btn-danger {
            background: #A78BFA;
            color: white;
        }

        .btn-danger:hover {
            background: #8B5CF6;
        }

        .btn-warning {
            background: #C4B5FD;
            color: white;
        }

        .btn-warning:hover {
            background: #A78BFA;
        }

        /* Timer - Integrated into header */
        .timer-container {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: center;
        }

        .timer-display {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #8B5CF6;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .timer-display.warning {
            background: #F59E0B;
            animation: pulse 1s infinite;
        }

        .timer-display.expired {
            background: #EF4444;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .timer-time {
            font-size: 40px;
            font-weight: 700;
            color: white;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls {
            display: flex;
            gap: 8px;
        }

        .btn-timer {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-timer-start {
            background: #10B981;
            color: white;
        }

        .btn-timer-pause {
            background: #6B7280;
            color: white;
        }

        .btn-timer-reset {
            background: #8B5CF6;
            color: white;
        }

        .timer-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #EF4444;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            display: none;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            min-width: 300px;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-text {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
        }

        .notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                order: 3;
            }

            .main-content {
                order: 1;
            }

            .speaker-response-container {
                grid-template-columns: 1fr;
            }

            .header {
                align-items: center;
            }

            .timer-container {
                width: 100%;
                justify-content: center;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9CA3AF;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Stack Faciliation</h1>
                <p>Eighth College Student Council</p>
            </div>
            <!-- Timer - Integrated into header -->
            <div class="timer-container">
                <div class="timer-display" id="timerDisplay">
                    <div class="timer-time" id="timerTime">3:00</div>
                </div>
                <div class="timer-controls">
                    <button class="btn-timer btn-timer-start" id="timerStartBtn">Start</button>
                    <button class="btn-timer btn-timer-pause" id="timerPauseBtn">Pause</button>
                    <button class="btn-timer btn-timer-reset" id="timerResetBtn">Reset</button>
                </div>
            </div>
        </div>

        <!-- Member Roster Sidebar -->
        <div class="sidebar">
            <h2>Members</h2>
            <div class="member-filter">
                <select id="memberFilter">
                    <option value="all">All Members</option>
                    <option value="core">CORE</option>
                    <option value="asn">ASN</option>
                    <option value="cpp">CPP</option>
                    <option value="finance">Finance</option>
                    <option value="soa">SOA</option>
                    <option value="tac">TAC</option>
                </select>
            </div>
            <div class="member-list" id="memberList"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Current Speaker and Response Queue -->
            <div class="speaker-response-container">
                <!-- Current Speaker -->
                <div class="current-speaker" id="currentSpeaker">
                    <div class="current-speaker-label">Current Speaker</div>
                    <div class="current-speaker-name" id="currentSpeakerName">No one speaking</div>
                    <div class="current-speaker-count" id="currentSpeakerCount"></div>
                    <button class="btn btn-primary speaker-action-btn" id="nextSpeakerBtn">Next Speaker →</button>
                </div>

                <!-- Response Queue -->
                <div class="response-queue">
                    <h2>Response Queue</h2>
                    <div class="response-list" id="responseList">
                        <div class="empty-state">No responses</div>
                    </div>
                    <button class="btn btn-warning response-action-btn" id="nextResponseBtn">Next Response →</button>
                </div>
            </div>

            <!-- Regular Stack Queue -->
            <div class="stack-section">
                <h2>Stack List</h2>
                <div class="stack-list" id="stackList">
                    <div class="empty-state">Stack is empty</div>
                </div>
                <div class="stack-controls">
                    <button class="btn btn-danger" id="clearStackBtn">Clear Stack</button>
                    <button class="btn btn-warning" id="resetCountsBtn">Reset All Counts</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Expiration Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <span class="notification-text" id="notificationText"></span>
            <button class="notification-close" id="notificationClose">×</button>
        </div>
    </div>

    <script>
        // Initial member data - easily editable
        let members = [
            { name: "Aditi", speakCount: 0 },
            { name: "Aidan", speakCount: 0 },
            { name: "Alyssa", speakCount: 0 },
            { name: "Anna", speakCount: 0 },
            { name: "Ariel", speakCount: 0 },
            { name: "Brigette", speakCount: 0 },
            { name: "Carina", speakCount: 0 },
            { name: "Clytie", speakCount: 0 },
            { name: "Devin", speakCount: 0 },
            { name: "Erica", speakCount: 0 },
            { name: "Evangelina", speakCount: 0 },
            { name: "Gabriela", speakCount: 0 },
            { name: "Hailey", speakCount: 0 },
            { name: "Holly", speakCount: 0 },
            { name: "Jonah", speakCount: 0 },
            { name: "Juliet", speakCount: 0 },
            { name: "Katherine", speakCount: 0 },
            { name: "Kavya", speakCount: 0 },
            { name: "Lucia", speakCount: 0 },
            { name: "Melany", speakCount: 0 },
            { name: "Rachel", speakCount: 0 },
            { name: "Robert", speakCount: 0 },
            { name: "Ryn", speakCount: 0 },
            { name: "Snigdha", speakCount: 0 },
            { name: "Svetlana", speakCount: 0 },
            { name: "Ximena", speakCount: 0 }
        ];

        // Member groups - easily editable
        const memberGroups = {
            "core": ["Aidan", "Rachel", "Hailey", "Robert", "Snigdha"],
            "asn": ["Hailey", "Alyssa", "Ryn", "Aditi", "Holly"],
            "cpp": ["Rachel", "Kavya", "Gabriela", "Melany", "Evangelina"],
            "finance": ["Snigdha", "Devin", "Ariel", "Carina", "Lucia"],
            "soa": ["Aidan", "Anna", "Juliet", "Ximena", "Erica"],
            "tac": ["Robert", "Clytie", "Katherine", "Svetlana", "Brigette"]
        };

        let selectedFilter = "all";


        let stack = [];
        let responseQueue = [];
        let currentSpeaker = null;
        let originalSpeaker = null; // Track original speaker before responses
        let timerInterval = null;
        let timerSeconds = 180; // 3 minutes
        let timerRunning = false;

        // Load from localStorage if available
        function loadState() {
            const saved = localStorage.getItem('stackKeeperState');
            if (saved) {
                const state = JSON.parse(saved);
                // Don't load members from localStorage - always use the code-defined members
                // But update speakCounts for members that exist in both
                if (state.members) {
                    state.members.forEach(savedMember => {
                        const currentMember = members.find(m => m.name === savedMember.name);
                        if (currentMember) {
                            currentMember.speakCount = savedMember.speakCount;
                        }
                    });
                }
                stack = state.stack || [];
                responseQueue = state.responseQueue || [];
                currentSpeaker = state.currentSpeaker || null;
                originalSpeaker = state.originalSpeaker || null;

                // Migrate old format: if stack items are objects with isResponse property
                if (stack.length > 0 && typeof stack[0] === 'object' && stack[0].hasOwnProperty('name')) {
                    const oldStack = stack;
                    stack = [];
                    oldStack.forEach(item => {
                        if (item.isResponse) {
                            responseQueue.push(item.name);
                        } else {
                            stack.push(item.name);
                        }
                    });
                    saveState(); // Save migrated data
                }
            }
        }

        // Save to localStorage
        function saveState() {
            const state = {
                members,
                stack,
                responseQueue,
                currentSpeaker,
                originalSpeaker
            };
            localStorage.setItem('stackKeeperState', JSON.stringify(state));
        }

        // Initialize
        function init() {
            loadState();
            renderMembers();
            renderStack();
            renderResponseList();
            updateCurrentSpeaker();
            updateTimerDisplay();

            // Timer controls
            document.getElementById('timerStartBtn').addEventListener('click', startTimer);
            document.getElementById('timerPauseBtn').addEventListener('click', pauseTimer);
            document.getElementById('timerResetBtn').addEventListener('click', resetTimer);

            // Stack controls
            document.getElementById('nextSpeakerBtn').addEventListener('click', nextSpeaker);
            document.getElementById('nextResponseBtn').addEventListener('click', nextResponse);
            document.getElementById('clearStackBtn').addEventListener('click', clearStack);
            document.getElementById('resetCountsBtn').addEventListener('click', resetCounts);

            // Notification close button
            document.getElementById('notificationClose').addEventListener('click', hideNotification);

            // Member filter
            document.getElementById('memberFilter').addEventListener('change', (e) => {
                selectedFilter = e.target.value;
                renderMembers();
            });
        }

        // Render member list
        function renderMembers() {
            const container = document.getElementById('memberList');
            container.innerHTML = '';

            // Filter members based on selected filter
            let filteredMembers = members;
            if (selectedFilter !== "all" && memberGroups[selectedFilter]) {
                const groupNames = memberGroups[selectedFilter];
                filteredMembers = members.filter(member => groupNames.includes(member.name));
            }

            filteredMembers.forEach((member, index) => {
                const card = document.createElement('div');
                card.className = 'member-card';

                const info = document.createElement('div');
                info.className = 'member-info';

                const name = document.createElement('span');
                name.className = 'member-name';
                name.textContent = member.name;

                const badge = document.createElement('span');
                badge.className = `speak-count-badge ${member.speakCount >= 2 ? 'high' : ''}`;
                badge.textContent = `${member.speakCount}×`;

                info.appendChild(name);
                info.appendChild(badge);

                const actions = document.createElement('div');
                actions.className = 'member-actions';

                const addBtn = document.createElement('button');
                addBtn.className = 'btn-small btn-add';
                addBtn.textContent = 'Add';
                addBtn.addEventListener('click', () => addToStack(member.name, false));

                const responseBtn = document.createElement('button');
                responseBtn.className = 'btn-small btn-response';
                responseBtn.textContent = 'Response';
                responseBtn.addEventListener('click', () => addToStack(member.name, true));

                actions.appendChild(addBtn);
                actions.appendChild(responseBtn);

                card.appendChild(info);
                card.appendChild(actions);

                container.appendChild(card);
            });
        }

        // Helper function to insert member in correct position based on speakCount
        function insertMemberInOrder(memberName, addToEnd = false) {
            const member = members.find(m => m.name === memberName);
            if (!member) return;

            if (addToEnd) {
                // Add to the very end regardless of count
                stack.push(memberName);
                return;
            }

            // Find the last position where someone has the same speakCount
            let lastSameCountIndex = -1;
            for (let i = stack.length - 1; i >= 0; i--) {
                const itemMember = members.find(m => m.name === stack[i]);
                if (itemMember && itemMember.speakCount === member.speakCount) {
                    lastSameCountIndex = i;
                    break;
                }
            }

            if (lastSameCountIndex !== -1) {
                // Insert after the last person with the same count
                stack.splice(lastSameCountIndex + 1, 0, memberName);
                return;
            }

            // No one has the same count, find the first position where someone has a higher count
            const insertIndex = stack.findIndex(memberNameInStack => {
                const itemMember = members.find(m => m.name === memberNameInStack);
                return itemMember && itemMember.speakCount > member.speakCount;
            });

            if (insertIndex === -1) {
                // Everyone has lower count, add to the end
                stack.push(memberName);
            } else {
                // Insert before the first person with higher count
                stack.splice(insertIndex, 0, memberName);
            }
        }

        // Add to stack with smart queue logic
        function addToStack(memberName, isResponse) {
            const member = members.find(m => m.name === memberName);
            if (!member) return;

            // Response queue always bypasses check
            if (isResponse) {
                // Save original speaker when first response is added while someone is speaking
                if (currentSpeaker && !originalSpeaker && responseQueue.length === 0) {
                    originalSpeaker = currentSpeaker;
                }
                responseQueue.push(memberName);
                renderResponseList();
                saveState();
                return;
            }

            // Add in order (lower counts come before higher counts)
            // This automatically places people with higher counts after those with lower counts
            insertMemberInOrder(memberName, false);
            renderStack();
            saveState();
        }

        // Render stack
        function renderStack() {
            const container = document.getElementById('stackList');
            container.innerHTML = '';

            if (stack.length === 0) {
                container.innerHTML = '<div class="empty-state">Stack is empty</div>';
                return;
            }

            stack.forEach((memberName, index) => {
                const member = members.find(m => m.name === memberName);
                if (!member) return;

                const stackItem = document.createElement('div');
                stackItem.className = 'stack-item';

                const info = document.createElement('div');
                info.className = 'stack-item-info';

                const position = document.createElement('div');
                position.className = 'stack-position';
                position.textContent = index + 1;

                const name = document.createElement('span');
                name.className = 'stack-item-name';
                name.textContent = memberName;

                const count = document.createElement('span');
                count.className = 'stack-item-count';
                count.textContent = `${member.speakCount}×`;

                info.appendChild(position);
                info.appendChild(name);
                info.appendChild(count);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', () => removeFromStack(index));

                stackItem.appendChild(info);
                stackItem.appendChild(removeBtn);

                container.appendChild(stackItem);
            });
        }

        // Remove from stack
        function removeFromStack(index) {
            stack.splice(index, 1);
            renderStack();
            saveState();
        }

        // Render response list
        function renderResponseList() {
            const container = document.getElementById('responseList');
            container.innerHTML = '';

            if (responseQueue.length === 0) {
                container.innerHTML = '<div class="empty-state">No responses</div>';
                return;
            }

            responseQueue.forEach((memberName, index) => {
                const member = members.find(m => m.name === memberName);
                if (!member) return;

                const responseItem = document.createElement('div');
                responseItem.className = 'response-item';

                const info = document.createElement('div');
                info.className = 'response-item-info';

                const position = document.createElement('div');
                position.className = 'stack-position';
                position.textContent = index + 1;

                const name = document.createElement('span');
                name.className = 'response-item-name';
                name.textContent = memberName;

                const count = document.createElement('span');
                count.className = 'response-item-count';
                count.textContent = `${member.speakCount}×`;

                info.appendChild(position);
                info.appendChild(name);
                info.appendChild(count);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', () => removeFromResponseQueue(index));

                responseItem.appendChild(info);
                responseItem.appendChild(removeBtn);

                container.appendChild(responseItem);
            });
        }

        // Remove from response queue
        function removeFromResponseQueue(index) {
            responseQueue.splice(index, 1);
            renderResponseList();
            saveState();
        }

        // Next speaker (only handles regular stack)
        function nextSpeaker() {
            if (currentSpeaker) {
                // Increment speak count for previous speaker
                const member = members.find(m => m.name === currentSpeaker);
                if (member) {
                    member.speakCount++;
                }
            }

            // Clear original speaker since we're moving to a completely new speaker
            originalSpeaker = null;

            // Move next person from regular stack to current speaker
            if (stack.length > 0) {
                currentSpeaker = stack[0];
                stack.shift();
            } else {
                currentSpeaker = null;
            }

            // Automatically reset timer when moving to next speaker
            resetTimer();
            // Start timer only if there's a new speaker
            if (currentSpeaker) {
                startTimer();
            }

            updateCurrentSpeaker();
            renderMembers();
            renderStack();
            saveState();
        }

        // Next response (handles responses within current speaker's time)
        function nextResponse() {
            if (currentSpeaker) {
                // Increment speak count for previous speaker (could be original speaker or responder)
                const member = members.find(m => m.name === currentSpeaker);
                if (member) {
                    member.speakCount++;
                }
            }

            // Prioritize response queue
            if (responseQueue.length > 0) {
                // Take next response - don't reset timer, continue within original speaker's time
                currentSpeaker = responseQueue[0];
                responseQueue.shift();
                // Timer continues without reset
            } else if (originalSpeaker) {
                // No more responses, return to original speaker if time remains
                currentSpeaker = originalSpeaker;
                originalSpeaker = null; // Clear since we're returning
                // Don't reset timer - continue with remaining time
            } else if (stack.length > 0) {
                // No responses and no original speaker, take from regular stack
                currentSpeaker = stack[0];
                stack.shift();
                // Reset timer for new speaker
                resetTimer();
                if (currentSpeaker) {
                    startTimer();
                }
            } else {
                currentSpeaker = null;
                originalSpeaker = null;
            }

            updateCurrentSpeaker();
            renderMembers();
            renderStack();
            renderResponseList();
            saveState();
        }

        // Update current speaker display
        function updateCurrentSpeaker() {
            const container = document.getElementById('currentSpeaker');
            const nameEl = document.getElementById('currentSpeakerName');
            const countEl = document.getElementById('currentSpeakerCount');

            if (currentSpeaker) {
                const member = members.find(m => m.name === currentSpeaker);
                container.classList.remove('empty');
                nameEl.textContent = currentSpeaker;
                countEl.textContent = `Speak count: ${member ? member.speakCount : 0}`;
            } else {
                container.classList.add('empty');
                nameEl.textContent = 'No one speaking';
                countEl.textContent = '';
            }
        }

        // Clear stack
        function clearStack() {
            if (confirm('Clear the entire stack and response queue? This will not reset speak counts.')) {
                stack = [];
                responseQueue = [];
                originalSpeaker = null;
                renderStack();
                renderResponseList();
                saveState();
            }
        }

        // Reset all counts
        function resetCounts() {
            if (confirm('Reset all speak counts to 0? This is typically done when moving to a new topic.')) {
                members.forEach(member => {
                    member.speakCount = 0;
                });
                renderMembers();
                saveState();
            }
        }

        // Timer functions
        function startTimer() {
            if (timerRunning) return;
            timerRunning = true;
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    pauseTimer();
                    showNotification();
                    const display = document.getElementById('timerDisplay');
                    display.classList.add('expired');
                } else if (timerSeconds <= 30) {
                    const display = document.getElementById('timerDisplay');
                    display.classList.add('warning');
                }
            }, 1000);
        }

        function pauseTimer() {
            timerRunning = false;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 180;
            const display = document.getElementById('timerDisplay');
            display.classList.remove('warning', 'expired');
            updateTimerDisplay();
            hideNotification();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerTime').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function showNotification() {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            if (currentSpeaker) {
                notificationText.textContent = `${currentSpeaker}'s 3 minutes are up!`;
            } else {
                notificationText.textContent = 'Time is up!';
            }
            
            notification.classList.add('show');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideNotification();
            }, 10000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
